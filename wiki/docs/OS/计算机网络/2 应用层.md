---
title: 2 应用层
---

### Principles of Network Applications

### The Web and HTTP


#### Overview of HTTP
The HyperText Transfer Protocol (HTTP), the Web’s application-layer protocol, is at the heart of the Web.

A **Web page**(also called a document) consists of objects. An **object** is simply a file.

Each URL has two components: the hostname of the server that houses the object and the object’s path name.


![Screen Shot 2018-12-19 at 11.44.48 P](figures/http_request-response_behavior.png)

HTTP uses TCP as its underlying transport protocol (rather than running on top of UDP).

It is important to note that the server sends requested files to clients without storing any state information about the client. If a particular client asks for the same object twice in a period of a few seconds, the server does not respond by saying that it just served the object to the client; instead, the server resends the object, as it has completely forgotten what it did earlier. Because an HTTP server maintains no information about the clients, HTTP is said to be a stateless protocol

#### Non-Persistent and Persistent Connections


#### HTTP Message Format


General format of an HTTP request message:

```python
GET /somedir/page.html HTTP/1.1  \r\n
# specifies the host on which the object resides
Host: www.someschool.edu \r\n
Connection: close  \r\n
User-agent: Mozilla/5.0  \r\n
Accept-language: fr \r\n
\r\n
```


![General_format_of_an_HTTP_request_message](figures/General_format_of_an_HTTP_request_message.png)

HTTP Request message has three sections:

* a request line: the method field, the URL field, and the HTTP version field
* header lines
* entity body: message

!!! note
    CR(Carriage Return, `\r`)表示回车, LF(Line Feed, `\n`)表示换行
    
    * Dos和Windows采用回车+换行(CR+LF)表示下一行
    * UNIX/Linux采用换行符(LF)表示下一行
    * MAC OS系统采用回车符(CR)表示下一行


```Python
# the server is using HTTP/1.1, everything is ok
HTTP/1.1 200 OK \r\n  
# the server tell the client close the tcp connection after sending the message
Connection: close  \r\n  
# the time when the HTTP response was created and sent by the server
Date: Wed, 19 Dec 2017 16:01:28 GMT \r\n
# the message was generated by an Apache Web server
Server: Apache/2.4.6 \r\n
# time when the object last modified
Last-Modified: Mon, 12 Nov 2018 16:25:17 GMT \r\n
ETag: "cf-57a7a257df256" \r\n
Accept-Ranges: bytes \r\n
# number of bytes in the object being sent
Content-Length: 207 \r\n
# the object in the entity body is HTML text
Content-Type: text/html; charset=UTF-8 \r\n
 \r\n
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta http-equiv="refresh"content="0;url=http://nyu.edu/projects/keithwross/">
<title> Automatic Forwarding </title>
</head>
```

![General format of an HTTP response message](figures/General_format_of_an_HTTP_response_message.png)


Response message has three sections: 

* a status line: protocol version field, a status code, a corresponding status message
*  header lines
*  entity body: message

#### Cookies


Cookies allow sites to keep track of users. A cookie technology has four components:

* a cookie header line in the HTTP response message;
* a cookie header line in the HTTP request message;
* a cookie file kept on the user's end system and managed by the user's browser;
* a back-end database at the Web site.


#### The Conditional Get

**Conditional GET** allows a cache to verity that its objects are up to date.

 An HTTP request message is a so-called conditional GET message if 
 
 * the request message uses the GET method
 * the request message includes an If-Modified-Since: header line


![conditional_get](figures/conditional_get.png)

#### Authentication
[HTTP Authentication Schemes](http://frontier.userland.com/stories/storyReader$2159)


* 客户端访问一个受http基本认证保护的资源。
* 服务器返回401状态码，要求客户端提供用户名和密码进行认证。响应头会加上WWW-Authenticate: Basic realm="请求域"。）

    ```python
    HTTP/1.1 401 Unauthorized\r\n
    Date: Thu, 20 Dec 2018 05:28:27 GMT\r\n
    Server: Apache/2.4.6 (CentOS)
    WWW-Authenticate: Basic realm="wireshark-students only"\r\n
    Content-Length: 381\r\n
    Keep-Alive: timeout=5, max=100\r\n
    Connection: Keep-Alive\r\n
    Content-Type: text/html; charset=iso-8859-1\r\n
    \r\n
    ```

* 客户端将输入的用户名密码用Base64进行编码后，采用非加密的明文方式传送给服务器。

    ```Python
    GET /wireshark-labs/protected_pages/HTTP-wiresharkfile5.html HTTP/1.1\r\n
    Host: gaia.cs.umass.edu\r\n
    Connection: keep-alive\r\n
    Authorization: Basic d2lyZXNoYXJrLXN0dWRlbnRzOm5ldHdvcms=\r\n
    Upgrade-Insecure-Requests: 1\r\n
    User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0)
    Accept: text/html,application/xhtml+xml,application/xml;
            q=0.9,image/webp,image/apng,*/*;q=0.8\r\n
    Accept-Encoding: gzip, deflate\r\n
    Accept-Language: zh-CN,zh;q=0.9,en;q=0.8\r\n
    \r\n
    ```

* 服务器将Authorization头中的用户名密码解码并取出，进行验证，如果认证成功，则返回相应的资源。如果认证失败，则仍返回401状态，要求重新进行认证。




### FTP

### SMTP

### DNS

There are two ways to identify a host –– by a *hostname* and an *IP address*. People prefer the more mnemonic hostname identifier, while routers prefer fixed-length, hierarchically structured IP addresses.

The main task of the Internet's **domain name system (DNS)** is translating hostnames to IP addresses. The DNS is 

* a **distributed** database implemented in a **hierarchy** of DNS servers
* an **application-layer protocol** that allows hosts to query the distributed database.


#### Overview of How DNS Works

Suppose that some application running in a user's host needs to translate a hostname to an IP address:

* The application will invoke the client side of DNS, specifying the hostname that needs to be translated.
* DNS in the user’s host then takes over, sending a query message into the network. All DNS query and reply messages are sent within UDP datagrams to port 53.
* After receiving a DNS reply message, the desired mapping is then passed to the invoking application.

##### A Distributed, Hierarchical Database

The DNS uses a large number of servers, organized in a hierarchical fashion and distributed around the world. There are three classes of DNS servers

* root DNS servers <small>根域名服务器</small>
    * 13 root DNS servers in 2006.
* top-level domain(TLD) DNS servers <small>顶级域名服务器</small>
    * responsible for top-level domain, such as com, org, net, edu
* authoritative DNS servers <small>权威域名服务器</small>
    * an organization can choose to implement its own authoritative DNS server (e.g. universities and large companies)
    * or pay to some service provider

![portion of the hierarchy of DNS servers](figures/portion_of_the_hierarchy_of_DNS_servers.png)


There is another important type of DNS server called the **local DNS server**(<small>本地域名服务器</small>).

* it does not strictly belong to the hierarchy of servers 
* but is nevertheless central to the DNS architecture.
* each ISP (e.g. university, company, residential ISP) has a local DNS server.


When a host makes a DNS query, the query is sent to the local DNS server, which acts a proxy, forwarding the query into the DNS server hierarchy.

Suppose the host `cis.poly.edu` desires the IP address of `gaia.cs.umass.edu`:

1. the host sends a DNS query to its local DNS server `dns.poly.edu`
2. the local DNS server forwards the query message to a root DNS server
3. the root DNS server takes note of the `edu` suffix and returns to the local DNS server a list of IP addresses for TLD servers responsible for `edu`.
4. the local DNS server then resends the query message to one of these TLD servers. 
5. the TLD server takes note of the `umass.edu` suffix and responds with the IP address of the authoritative DNS server for the University of Massachusetts, namely, `dns.umass.edu`. 
6. the local DNS server resends the query message directly to `dns.umass.edu`
7. the authoritative DNS sever for `dns.umass.edu` responds with the IP address of `gaia.cs.umass.edu`. 

Note that in this example, in order to obtain the mapping for one hostname, eight DNS messages were sent: four query messages and four reply messages! We’ll see how DNS caching reduces this query traffic in next section.

![Interaction_of_the_various_DNS_servers](figures/Interaction_of_the_various_DNS_servers.png)

In theory, any DNS query can be iterative or recursive. For example, Figure below shows a DNS query chain for which all of the queries are recursive. 

In practice, the queries typically follow the pattern in Figure above: The query from the requesting host to the local DNS server is recursive, and the remaining queries are iterative.

![recursive_queirs_in_DNS](figures/recursive_queirs_in_DNS.png)


##### DNS Caching

In a query chain, When a DNS server receives a DNS reply, it can cache the mapping in its local memory.

If a hostname/IP address pair is cached in a DNS server and another query arrives to the DNS server for the same hostname, the DNS server can provide the desired IP address, even if it is not authoritative for the hostname.

Because hosts and mappings between hostnames and IP addresses are by no means permanent, DNS servers discard cached information after a period of time (often set to two days).

#### DNS records and Messages




### P2P

### Socket Programming

### WireShark Lab

#### WireShark Lab: HTTP

略
#### Wireshark Lab: DNS

### Socket Programming Assignments

#### Web Server

#### UDP Pinger

#### Mail Client